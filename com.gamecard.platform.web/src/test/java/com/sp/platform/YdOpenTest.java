package com.sp.platform;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.sp.platform.util.Encrypt;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.junit.Test;

import java.io.IOException;

/**
 * Created by yanglei on 15/6/22.
 */
public class YdOpenTest {
    public String getSessionKeyTest() throws IOException {
        HttpClient client = new DefaultHttpClient();
        long epoch = System.currentTimeMillis() / 1000;
        String url = "http://g.10086.cn/pay/open/index?";
        String body2 = "app=cwbk&method=getsessionkey&time=" + epoch + "&key=c4574c3ffefc72da84901614e345a7dd";
        url = url + "app=cwbk&method=getsessionkey&format=json&time=" + epoch + "&hash=" + Encrypt.md532(body2);
        System.out.println(url);
        HttpGet httpGet = new HttpGet(url);
        httpGet.addHeader("Content-Type", "application/json;charset=UTF-8");
        httpGet.addHeader("accept", "application/json;charset=UTF-8");

        //处理请求，得到响应
        HttpResponse httpResponse = client.execute(httpGet);
        String body = IOUtils.toString(httpResponse.getEntity().getContent(), "UTF-8");
        System.out.println(httpResponse.getStatusLine().getStatusCode() + " : " + body);
        JSONObject json = JSON.parseObject(body);
        if (json.get("resultCode") != null) {
            if (StringUtils.equals("2000", json.get("resultCode").toString())) {
                return json.get("sessionkey").toString();
            }
        }
        return "";
    }

    @Test
    public void verifyCodeTest() throws IOException {
        String sessionKey = getSessionKeyTest();
        if (StringUtils.isBlank(sessionKey)) {
            return;
        }
        String mobile = "13586212908";
        HttpClient client = new DefaultHttpClient();
        long epoch = System.currentTimeMillis() / 1000;
        String url = "http://g.10086.cn/pay/open/index?";
        String body2 = "app=cwbk&method=applyforpurchase"
                + "&tel=" + mobile
                + "&consumecode=006077839001"
                + "&time=" + epoch
                + "&sessionkey=" + sessionKey
                + "&key=c4574c3ffefc72da84901614e345a7dd";

        url = url + "app=cwbk&method=applyforpurchase&format=json&time=" + epoch
                + "&tel=" + mobile
                + "&consumecode=006077839001"
                + "&salechannelid=41937000"
                + "&sessionkey=" + sessionKey
                + "&hash=" + Encrypt.md532(body2);
        System.out.println(url);
        HttpGet httpGet = new HttpGet(url);
        httpGet.addHeader("Content-Type", "application/json;charset=UTF-8");
        httpGet.addHeader("accept", "application/json;charset=UTF-8");

        //处理请求，得到响应
        HttpResponse httpResponse = client.execute(httpGet);
        String body = IOUtils.toString(httpResponse.getEntity().getContent(), "UTF-8");
        System.out.println(httpResponse.getStatusLine().getStatusCode() + " : " + body);
    }

    @Test
    public void payTest() throws IOException {
        String sessionKey = getSessionKeyTest();
        if (StringUtils.isBlank(sessionKey)) {
            return;
        }
        String orderId = "0700000f2514840400438396";
        HttpClient client = new DefaultHttpClient();
        long epoch = System.currentTimeMillis() / 1000;
        String url = "http://g.10086.cn/pay/open/index?";
        String body2 = "app=cwbk&method=confirmpurchase"
                + "&verifycode=471702"
                + "&orderid=" + orderId
                + "&time=" + epoch
                + "&sessionkey=" + sessionKey
                + "&key=c4574c3ffefc72da84901614e345a7dd";

        url = url + "app=cwbk&method=confirmpurchase&format=json&time=" + epoch
                + "&verifycode=471702"
                + "&orderid=" + orderId
                + "&time=" + epoch
                + "&sessionkey=" + sessionKey
                + "&hash=" + Encrypt.md532(body2);
        System.out.println(url);
        HttpGet httpGet = new HttpGet(url);
        httpGet.addHeader("Content-Type", "application/json;charset=UTF-8");
        httpGet.addHeader("accept", "application/json;charset=UTF-8");

        //处理请求，得到响应
        HttpResponse httpResponse = client.execute(httpGet);
        String body = IOUtils.toString(httpResponse.getEntity().getContent(), "UTF-8");
        System.out.println(httpResponse.getStatusLine().getStatusCode() + " : " + body);
    }

    @Test
    public void informTest() throws IOException {
        String sessionKey = getSessionKeyTest();
        if (StringUtils.isBlank(sessionKey)) {
            return;
        }
        String orderId = "0700000f2514840400438396";
        HttpClient client = new DefaultHttpClient();
        long epoch = System.currentTimeMillis() / 1000;
        String url = "http://g.10086.cn/pay/open/index?";
        String body2 = "app=cwbk&method=informpurchaseresult"
                + "&result=true"
                + "&orderid=" + orderId
                + "&time=" + epoch
                + "&sessionkey=" + sessionKey
                + "&key=c4574c3ffefc72da84901614e345a7dd";

        url = url + "app=cwbk&method=informpurchaseresult&format=json&time=" + epoch
                + "&result=true"
                + "&orderid=" + orderId
                + "&time=" + epoch
                + "&sessionkey=" + sessionKey
                + "&hash=" + Encrypt.md532(body2);
        System.out.println(url);
        HttpGet httpGet = new HttpGet(url);
        httpGet.addHeader("Content-Type", "application/json;charset=UTF-8");
        httpGet.addHeader("accept", "application/json;charset=UTF-8");

        //处理请求，得到响应
        HttpResponse httpResponse = client.execute(httpGet);
        String body = IOUtils.toString(httpResponse.getEntity().getContent(), "UTF-8");
        System.out.println(httpResponse.getStatusLine().getStatusCode() + " : " + body);
    }
}